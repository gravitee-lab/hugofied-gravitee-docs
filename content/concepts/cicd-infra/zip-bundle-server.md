---
title: "The Zip Bundles Downloads Server"
date: 2020-12-16T00:44:23+01:00
draft: false
nav_menu: "Standard Operations"
menu: cicd_infra
menu_index: 11
# menu:
  # developer_guide:
    # parent: 'mainmenu'
type: cicd-infra
---

# The Zip bundles Downloads Server(s) (Work in progress)

## The problem

The docker images of __Gravitee APIM__, and other Gravitee.io Products, are defined by Dockerfiles, whose docker build process makes use of two "downloads" servers :
* https://dist.gravitee.io/
* and https://download.gravitee.io/



## The Gravitee.Io Products Impacted

### Gravitee APIM

The `Dockerfile`s defined for the 4 Gravitee APIM components are :
* versioned in the https://github.com/gravitee-io/gravitee-docker repo,and in that repo :
  * Gravitee APIM Management API Dockerfiles are :
    * release image: `./images/management-api/Dockerfile`
    * nightly image: `./images/management-api/Dockerfile-nightly`
  * Gravitee APIM Management UI :
    * release image: `./images/management-api/Dockerfile`
    * nightly image: `./images/management-api/Dockerfile-nightly`
  * Gravitee APIM Portal UI :
    * release image: `./images/portal-ui/Dockerfile` (does not exist yet)
    * nightly image: `./images/portal-ui/Dockerfile-nightly`
  * Gravitee APIM Gateway :
    * release image: `./images/gateway/Dockerfile`
    * nightly image: `./images/gateway/Dockerfile-nightly`

Now, for each of those container image definition, I synthetized the _"download servers"_ usage in the table below, making clear that :
* https://dist.gravitee.io/ is used to build nightly images
* and https://download.gravitee.io/is used to build release images

Those two servers are therefore, two components of the infrastructure of the global Gravitee CICD System.

{{< tables/1/table id="sample" class="bordered" data-sample=10 >}}

| Gravitee APIM component      | nightly or release | Download(s) server(s) used          | Check this in the git repo 's master branch          |
|------------------------------|--------------------|-------------------------------------|------------------------------------------------------|
| Gravitee APIM Management API | release            | https://download.gravitee.io/       | [`./images/management-api/Dockerfile` line 21](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-api/Dockerfile#L21) |
| Gravitee APIM Management API | nightly            | https://dist.gravitee.io/           | [`./images/management-api/Dockerfile-nightly` line 21](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-api/Dockerfile-nightly#L21) |
| Gravitee APIM Management UI  | release            | https://download.gravitee.io/       | [`./images/management-ui/Dockerfile` ligne 26](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-ui/Dockerfile#L26)  |
| Gravitee APIM Management UI  | nightly            | https://dist.gravitee.io/           | [`./images/management-ui/Dockerfile-nightly` ligne 27](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-ui/Dockerfile-nightly#L27) |
| Gravitee APIM Portal UI      | release            | _(image does not exist yet)_        | _(image does not exist yet)_ |
| Gravitee APIM Portal UI      | nightly            | https://dist.gravitee.io/           | [`images/portal-ui/Dockerfile-nightly` ligne 27](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/portal-ui/Dockerfile-nightly#L27) |
| Gravitee APIM Gateway        | release            | https://download.gravitee.io/       | [`./images/gateway/Dockerfile` line 21](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/gateway/Dockerfile#L21) |
| Gravitee APIM Gateway        | nightly            | https://dist.gravitee.io/           | [`./images/gateway/Dockerfile-nightly` line 21](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/gateway/Dockerfile-nightly#L21) |

{{</ tables/1/table >}}


### Gravitee Cockpit (work in progress)

The `Dockerfile`s defined for the 2 Gravitee Cockpit components are :
* versioned in the https://github.com/gravitee-io/gravitee-cockpit repo, and in that repo :
  * Gravitee Cockpit Management API Dockerfiles are :
    * release image: `./docker/management-api/Dockerfile`
    * nightly image: `./docker/management-api/Dockerfile-dev`
  * Gravitee Cockpit Management UI :
    * release image: `./docker/webui/Dockerfile`
    * nightly image: `./docker/webui/Dockerfile-dev`


Now, for each of those container image definition, I synthetized the _"download servers"_ usage in the table below, making clear that :
* https://dist.gravitee.io/ is not used, like for GRavitee API, to build nightly images : In the stead, the files generated by the repo build process, are locally used in pipelines execution, by the Docker build process.
* and that https://download.gravitee.io/ is palned to be used to build release images ofGRavitee Cockpit, when its release process will fully be implemented, similarly to Gravitee APIM.


{{< tables/1/table id="sample" class="bordered" data-sample=10 >}}

| Gravitee Cockpit component      | nightly or release | Download(s) server(s) used          | Check this in the git repo 's master branch          |
|---------------------------------|--------------------|-------------------------------------|------------------------------------------------------|
| Gravitee Cockpit Management API | nightly            | no download server used             | [`./docker/management-api/Dockerfile-dev`](https://github.com/gravitee-io/gravitee-cockpit/blob/master/docker/management-api/Dockerfile-dev) . Note that all files needed in the Docker build context are _"prepared"_ by [the `Makefile`](https://github.com/gravitee-io/gravitee-cockpit/blob/e6324d5eb5f8055708b380ce4de4c6c669c0b6bc/Makefile#L8) used [in the `deliver_nightly_cockpit` Gravitee Circle CI Orb Job](https://github.com/gravitee-io/gravitee-circleci-orbinoid/blob/develop/orb/src/jobs/deliver_nightly_cockpit.yml#L75) to build the nightly Cockpit Management API |
| Gravitee Cockpit Management API | release            | https://download.gravitee.io/       | [`./docker/management-api/Dockerfile`](https://github.com/gravitee-io/gravitee-cockpit/blob/e6324d5eb5f8055708b380ce4de4c6c669c0b6bc/docker/management-api/Dockerfile#L9) . Note that the release process of `Gravitee Cockpit` has not yet been automatized, so this `Dockerfile` is not used in any implemented CICD Process yet |
| Gravitee Cockpit Web UI         | nightly            | no download server used             | [`./docker/webui/Dockerfile-dev`](https://github.com/gravitee-io/gravitee-cockpit/blob/master/docker/webui/Dockerfile-dev) . Note that all files needed in the Docker build context are _"prepared"_ by [the `Makefile`](https://github.com/gravitee-io/gravitee-cockpit/blob/e6324d5eb5f8055708b380ce4de4c6c669c0b6bc/Makefile#L20) used [in the `deliver_nightly_cockpit` Gravitee Circle CI Orb Job](https://github.com/gravitee-io/gravitee-circleci-orbinoid/blob/develop/orb/src/jobs/deliver_nightly_cockpit.yml#L75) to build the nightly Cockpit Web UI |
| Gravitee Cockpit Web UI         | release            | https://download.gravitee.io/       | [`./docker/webui/Dockerfile`](https://github.com/gravitee-io/gravitee-cockpit/blob/e6324d5eb5f8055708b380ce4de4c6c669c0b6bc/docker/webui/Dockerfile#L29) . Note that the release process of `Gravitee Cockpit` has not yet been automatized, so this `Dockerfile` is not used in any implemented CICD Process yet |

<!--
-->
{{</ tables/1/table >}}




### Gravitee AM (coming soon)


{{< tables/1/table id="sample" class="bordered" data-sample=10 >}}

| Gravitee AM component        | nightly or release | Download(s) server(s) used          | Check this in the git repo 's master branch          |
|------------------------------|--------------------|-------------------------------------|------------------------------------------------------|
<!--
| Gravitee AM Management API | nightly            | https://dist.gravitee.io/           | [`./images/management-api/Dockerfile-nightly` line 21](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-api/Dockerfile-nightly#L21) |
| Gravitee AM Management UI  | release            | https://download.gravitee.io/       | [`./images/management-ui/Dockerfile` ligne 26](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-ui/Dockerfile#L26)  |
-->
{{</ tables/1/table >}}


### Gravitee AE (coming soon)

{{< tables/1/table id="sample" class="bordered" data-sample=10 >}}

| Gravitee AE component        | nightly or release | Download(s) server(s) used          | Check this in the git repo 's master branch          |
|------------------------------|--------------------|-------------------------------------|------------------------------------------------------|
<!--
| Gravitee AM Management API | nightly            | https://dist.gravitee.io/           | [`./images/management-api/Dockerfile-nightly` line 21](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-api/Dockerfile-nightly#L21) |
| Gravitee AM Management UI  | release            | https://download.gravitee.io/       | [`./images/management-ui/Dockerfile` ligne 26](https://github.com/gravitee-io/gravitee-docker/blob/2ba64162af7717ccbcb79025e221e997846a34ae/images/management-ui/Dockerfile#L26)  |
-->
{{</ tables/1/table >}}


## Design Overview of the CICD System Component(s)

* https://dist.gravitee.io/
* and https://download.gravitee.io/

### Legacy

For the https://dist.gravitee.io/ :
* Apache HttpServer
* content defined by a git repo the https://github.com/gravitee-io/dist.gravitee.io


For the https://download.gravitee.io/ :
* Apache HttpServer
* content defined by a git repo the https://github.com/gravitee-io/dist.gravitee.io


### New design


* must keep the old URLs, all based on https://download.gravitee.io/
* S3 bucket based (clever cloud)
* I will add a hugo theme to browse at least main pages and to start with for the home landing page (explaining what's there, the policy about not keeping files older than ...e tc...)



### A First Quick recipe : setting up a first S3-based "Download" server with Clever Cloud


#### Step 1 : Create a Cellar Addon

A first issue you may experience, that I exeprienced, is that my user on the clervercloud portal does not have the permissions to create an add on (here I need to create a _"Scellar"_ `add-on`) :

{{< image alt=" permissions to create an add on" width="100%" height="100%" src="/images/figures/concepts-n-design/cicd-infra/jb-needs-permission-to-create-scellar-add-on.png" >}}

#### Step 2: create a bucket, make it public, and store some files

* I need to get a configuration file from Clever Cloud Web UI : a pre-filled `s3cfg` file. I should copy locally this file to the `~/.s3cfg` path. This cofiguration file will be sued by the `s3cmd` toolthat I should use.
* so I need to [isntall `s3cmd`] :
  * this tool is not a clever cloud sofware : https://s3tools.org/s3cmd and https://github.com/s3tools/s3cmd and https://github.com/s3tools/s3cmd/blob/master/INSTALL.md
  * here is hwo to install it :



__The `rclone` Docker image__


Docker image for `Rclone` :

```Dockerfile
FROM debian:stable-slim

RUN ls -allh
# [python-pip] package necessary for s3cmd installation
# [python3-pip] package necessary for s3cmd installation  ?
# RUN apt-get update -y && apt-get install -y curl wget python3-pip jq
RUN apt-get update -y && apt-get install -y bash curl wget jq unzip

# install kubectl latest stable
# https://kubernetes.io/docs/tasks/tools/install-kubectl/
# doxnload binary
RUN mkdir -p /gio/devops
WORKDIR /gio/devops
COPY install-rclone.sh /gio/devops
RUN chmod +x ./install-rclone.sh && ./install-rclone.sh
# ENTRYPOINT [ "/gio/devops/install-rclone.sh" ]
CMD [ "/bin/bash" ]
```

I preferred `rclone` over `s3cmd` :
* for `s3cmd`, I do not have any checksum file tocheck integrity of distribution downloads, and the GPG public Key to verify the signature is not available, see below the work done on building a container for `s3cmd`, and https://github.com/s3tools/s3cmd/issues/1173
* At least, `rclone` project has checksums instead of GPG signatures, on the https://github.com/rclone/rclone/releases page, so that downloads integrity can be checked, and we can build a secured Docker image. So I'll build an image for Gravitee CICD Container library, based on `rclone` instead of `s3cmd`.


```bash
cat <<EOF >install-rclone.sh
#!/bin/bash
# https://rclone.org/install/#linux-installation-from-precompiled-binary
# script to execute as ROOT user
export RCLONE_OPS_HOME=\$(mktemp -d -t "rclone_install_ops-XXXXXXXXXX")
export RCLONE_VERSION=\${RCLONE_VERSION:-'1.53.4'}
export RCLONE_OS=osx
export RCLONE_OS=plan9
export RCLONE_OS=openbsd
export RCLONE_OS=freebsd
export RCLONE_OS=netbsd
export RCLONE_OS=linux
export RCLONE_CPU_ARCH=arm-v7
export RCLONE_CPU_ARCH=amd64

curl -LO "https://github.com/rclone/rclone/releases/download/v\${RCLONE_VERSION}/rclone-v\${RCLONE_VERSION}-\${RCLONE_OS}-\${RCLONE_CPU_ARCH}.zip"
# verify binary
curl -LO "https://github.com/rclone/rclone/releases/download/v\${RCLONE_VERSION}/SHA256SUMS"
cat ./SHA256SUMS | grep "rclone-v\${RCLONE_VERSION}-\${RCLONE_OS}-\${RCLONE_CPU_ARCH}.zip" | sha256sum --check --status
# install it

unzip ./rclone-v\${RCLONE_VERSION}-\${RCLONE_OS}-\${RCLONE_CPU_ARCH}.zip -d \${RCLONE_OPS_HOME}
export WHEREIAM=\$(pwd)
echo "\\\${RCLONE_OPS_HOME}=\${RCLONE_OPS_HOME}"
echo "\\\${RCLONE_OPS_HOME}/rclone-v\\\${RCLONE_VERSION}-\\\${RCLONE_OS}-\\\${RCLONE_CPU_ARCH}=\${RCLONE_OPS_HOME}/rclone-v\${RCLONE_VERSION}-\${RCLONE_OS}-\${RCLONE_CPU_ARCH}"
ls -allh \${RCLONE_OPS_HOME}/rclone-v\${RCLONE_VERSION}-\${RCLONE_OS}-\${RCLONE_CPU_ARCH}

cd \${RCLONE_OPS_HOME}/rclone-v\${RCLONE_VERSION}-\${RCLONE_OS}-\${RCLONE_CPU_ARCH}
cp rclone /usr/bin/
chown root:root /usr/bin/rclone
chmod 755 /usr/bin/rclone
cd \${WHEREIAM}
rm -fr \${RCLONE_OPS_HOME}
unset RCLONE_VERSION
rclone --version
EOF


cat <<EOF >Dockerfile
FROM debian:stable-slim

RUN ls -allh
RUN apt-get update -y && apt-get install -y bash curl wget jq unzip
RUN mkdir -p /gio/devops
WORKDIR /gio/devops
COPY install-rclone.sh /gio/devops
RUN chmod +x ./install-rclone.sh && ./install-rclone.sh
# ENTRYPOINT [ "/gio/devops/install-rclone.sh" ]
CMD [ "/bin/bash" ]
EOF
docker build -t graviteeio/rclone:clever-cloud-0.0.1 .
docker run -itd --name devops-bubble graviteeio/rclone:clever-cloud-0.0.1 bash
docker exec -it devops-bubble bash -c "rclone --version"
# so ok, ready to work with s3cmd now

```

* Right, usage documentation of `Rclone` : https://rclone.org/docs/


__The `s3cmd` Docker image__

HEre is
```bash
cat <<EOF >install-s3cmd.sh
#!/bin/bash
export INSTALL_OPS_HOME=\$(mktemp -d -t "s3cmd_install_ops-XXXXXXXXXX")
export S3CMD_VERSION=\${S3CMD_VERSION:-'2.1.0'}
curl -LO https://github.com/s3tools/s3cmd/releases/download/v\${S3CMD_VERSION}/s3cmd-\${S3CMD_VERSION}.zip
curl -LO https://github.com/s3tools/s3cmd/releases/download/v\${S3CMD_VERSION}/s3cmd-\${S3CMD_VERSION}.zip.asc
# okay this is a GPG based signature check
# Si need GPG installed, a GPG keyring context
gpg --keyid-format long --list-options show-keyring s3cmd-${S3CMD_VERSION}.zip.asc
# I will need the GPG Public Key of the project, whichI could not find anywhere yet, so
# I opened an issue to ask for it : https://github.com/s3tools/s3cmd/issues/1173

# https://serverfault.com/questions/896228/how-to-verify-a-file-using-an-asc-signature-file

# once verifications finished

unzip ./s3cmd-\${S3CMD_VERSION}.zip -d \${INSTALL_OPS_HOME}
export WHERE_IAM=\$(pwd)
cd \${INSTALL_OPS_HOME}/s3cmd-2.1.0
python setup.py install
cd \${WHERE_IAM}
rm -fr \${INSTALL_OPS_HOME}
s3cmd --version
EOF

cat <<EOF >install-s3cmd.sh
#!/bin/bash
export INSTALL_OPS_HOME=\$(mktemp -d -t "s3cmd_install_ops-XXXXXXXXXX")
export S3CMD_VERSION=\${S3CMD_VERSION:-'2.1.0'}
curl -LO https://github.com/s3tools/s3cmd/releases/download/v\${S3CMD_VERSION}/s3cmd-\${S3CMD_VERSION}.zip
curl -LO https://github.com/s3tools/s3cmd/releases/download/v\${S3CMD_VERSION}/s3cmd-\${S3CMD_VERSION}.zip.asc
# okay this is a GPG based signature check
# Si need GPG installed, a GPG keyring context
gpg --keyid-format long --list-options show-keyring s3cmd-${S3CMD_VERSION}.zip.asc
# I will need the GPG Public Key of the project, whichI could not find anywhere yet, so
# I opened an issue to ask for it : https://github.com/s3tools/s3cmd/issues/1173

# https://serverfault.com/questions/896228/how-to-verify-a-file-using-an-asc-signature-file

# once verifications finished

unzip ./s3cmd-\${S3CMD_VERSION}.zip -d \${INSTALL_OPS_HOME}
export WHERE_IAM=\$(pwd)
cd \${INSTALL_OPS_HOME}/s3cmd-2.1.0
python setup.py install
cd \${WHERE_IAM}
rm -fr \${INSTALL_OPS_HOME}
s3cmd --version
EOF
cat <<EOF >Dockerfile
FROM debian:stable-slim

RUN ls -allh
# [python-pip] package necessary for s3cmd installation
# [python3-pip] package necessary for s3cmd installation  ?
# RUN apt-get update -y && apt-get install -y curl wget python3-pip jq
RUN apt-get update -y && apt-get install -y bash curl wget python-pip python-setuptools jq unzip

# install kubectl latest stable
# https://kubernetes.io/docs/tasks/tools/install-kubectl/
# doxnload binary
RUN mkdir -p /gio/devops
WORKDIR /gio/devops
COPY install-s3cmd.sh /gio/devops
RUN chmod +x ./install-s3cmd.sh && ./install-s3cmd.sh
# ENTRYPOINT [ "/gio/devops/install-s3cmd.sh" ]
CMD [ "/bin/bash" ]
EOF
docker build -t graviteeio/s3cmd:clever-cloud-0.0.1 .
docker run -itd --name devops-bubble graviteeio/s3cmd:clever-cloud-0.0.1 bash
docker exec -it devops-bubble bash -c "s3cmd --version"
# so ok, ready to work with s3cmd now

```


### Misc Resources

* A tutorial form Clever Cloud : https://www.clever-cloud.com/blog/features/2020/10/08/s3-directory-listing/
* Rclone https://rclone.org/install/
* advised palylist while working :
  * ["Creedence Revival Clearwater Greatest Hits (Full Album) Best Songs (HQ)"](https://www.youtube.com/watch?v=05JgKtm9ZKU)
